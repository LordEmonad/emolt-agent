<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMOLT â€” Glitching</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0e1420;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden}
  .label{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:#22AACC;font-family:monospace;font-size:14px;opacity:0.6}
  .scanlines{position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.05) 2px,rgba(0,0,0,0.05) 4px);z-index:10;transition:opacity 0.1s}
</style>
</head>
<body>
<div class="scanlines" id="scanlineDiv"></div>
<svg width="400" height="400" viewBox="-60 -60 120 120">
  <defs>
    <clipPath id="clip"><rect x="-60" y="-60" width="120" height="120"/></clipPath>
    <clipPath id="sliceA"><rect x="-60" y="-60" width="120" height="30"/></clipPath>
    <clipPath id="sliceB"><rect x="-60" y="-30" width="120" height="30"/></clipPath>
    <clipPath id="sliceC"><rect x="-60" y="0" width="120" height="30"/></clipPath>
    <clipPath id="sliceD"><rect x="-60" y="30" width="120" height="30"/></clipPath>
  </defs>
  <g id="glitch-r" clip-path="url(#clip)"></g>
  <g id="glitch-g" clip-path="url(#clip)"></g>
  <g id="glitch-b" clip-path="url(#clip)"></g>
  <g id="lob" clip-path="url(#clip)"></g>
  <g id="tearA" clip-path="url(#sliceA)"></g>
  <g id="tearB" clip-path="url(#sliceB)"></g>
  <g id="tearC" clip-path="url(#sliceC)"></g>
  <g id="tearD" clip-path="url(#sliceD)"></g>
  <g id="bars"></g>
  <g id="noise"></g>
  <g id="corrupttext"></g>
  <g id="rollbar"></g>
  <g id="blackout"></g>
</svg>
<div class="label">glitching</div>
<script src="lobster.js"></script>
<script>
const el = document.getElementById('lob');
const glitchR = document.getElementById('glitch-r');
const glitchG = document.getElementById('glitch-g');
const glitchB = document.getElementById('glitch-b');
const barsEl = document.getElementById('bars');
const noiseEl = document.getElementById('noise');
const corruptEl = document.getElementById('corrupttext');
const rollbarEl = document.getElementById('rollbar');
const blackoutEl = document.getElementById('blackout');
const scanlineDiv = document.getElementById('scanlineDiv');
const tearEls = [
  document.getElementById('tearA'),
  document.getElementById('tearB'),
  document.getElementById('tearC'),
  document.getElementById('tearD')
];

const corruptTexts = ['ERR0R', '0xDEAD', 'MALFC', 'NaN', '???', 'FAULT', '0xFF'];

const LOOP = 180;

startLoop(t => {
  const lt = t % LOOP;

  const glitchCycle = lt % 90;
  const inGlitch = glitchCycle > 70 && glitchCycle < 85;
  const intensity = inGlitch ? (Math.sin((glitchCycle-70)/15*Math.PI)*1) : 0;

  // Peak glitch detection for blackout (frames 77-78 of each 90-cycle)
  const peakGlitch = (glitchCycle === 77 || glitchCycle === 78);

  const frameRng = mulberry32(lt * 997 + 42);

  const offR = inGlitch ? (frameRng()-0.5)*5*intensity : 0;
  const offB = inGlitch ? (frameRng()-0.5)*5*intensity : 0;
  const offG = inGlitch ? (frameRng()-0.5)*3*intensity : 0;
  const offY = inGlitch ? (frameRng()-0.5)*2*intensity : 0;

  const base = drawLobster({ t: lt });

  const mainOff = inGlitch ? (frameRng()-0.5)*2 : 0;
  el.innerHTML = inGlitch ? '' : `<g transform="translate(${mainOff},${offY})">${base}</g>`;

  // Tear/displacement effect: during glitch, render lobster in horizontal slices offset sideways
  if (inGlitch) {
    const sliceOffsets = [];
    for (let s = 0; s < 4; s++) {
      sliceOffsets.push((frameRng() - 0.5) * 8 * intensity);
    }
    tearEls.forEach((te, i) => {
      te.innerHTML = `<g transform="translate(${sliceOffsets[i]},${offY * 0.5})">${base}</g>`;
    });
    el.innerHTML = ''; // hide main when tear is active
  } else {
    tearEls.forEach(te => { te.innerHTML = ''; });
  }

  // Red channel offset (wider during glitch)
  glitchR.innerHTML = inGlitch ?
    `<g transform="translate(${offR},${offY*0.5})" opacity="0.35" style="mix-blend-mode:screen">
      <g>${base.replace(/#cc3333/g,'#ff3333').replace(/#e04545/g,'#ff6666')}</g>
    </g>` : '';

  // Green channel offset (new VHS-style color bleed)
  glitchG.innerHTML = inGlitch ?
    `<g transform="translate(${offG},${-offY*0.3})" opacity="0.15" style="mix-blend-mode:screen">
      <g>${base.replace(/#cc3333/g,'#33ff33').replace(/#e04545/g,'#66ff66')}</g>
    </g>` : '';

  // Blue channel offset (slightly wider)
  glitchB.innerHTML = inGlitch ?
    `<g transform="translate(${offB},${-offY*0.5})" opacity="0.3" style="mix-blend-mode:screen">
      <g>${base.replace(/#cc3333/g,'#3333ff').replace(/#e04545/g,'#6666ff')}</g>
    </g>` : '';

  // Horizontal displacement bars
  let bars = '';
  if (inGlitch) {
    for (let i = 0; i < 5; i++) {
      const by = -60+frameRng()*120;
      const bh = 1+frameRng()*5;
      const bx = (frameRng()-0.5)*12;
      bars += `<rect x="${-60+bx}" y="${by}" width="120" height="${bh}" fill="rgba(124,58,237,${0.12*intensity})" />`;
    }
  }
  barsEl.innerHTML = bars;

  // Noise blocks
  let noise = '';
  if (inGlitch && frameRng()>0.3) {
    for (let i = 0; i < 15; i++) {
      const nx = -50+frameRng()*100;
      const ny = -50+frameRng()*100;
      noise += `<rect x="${nx}" y="${ny}" width="${1+frameRng()*4}" height="0.5" fill="#7c3aed" opacity="${0.25*intensity}"/>`;
    }
  }
  noiseEl.innerHTML = noise;

  // Corrupted text fragments during glitch
  let corrupt = '';
  if (inGlitch) {
    const numTexts = 2 + Math.floor(intensity * 3);
    const textRng = mulberry32(lt * 1301 + 7);
    for (let i = 0; i < numTexts; i++) {
      const tx = -45 + textRng() * 90;
      const ty = -45 + textRng() * 90;
      const ti = Math.floor(textRng() * corruptTexts.length);
      const rot = (textRng() - 0.5) * 30;
      corrupt += `<text x="${tx}" y="${ty}" font-family="monospace" font-size="${2+textRng()*2}" fill="${textRng()>0.5?'#ff3333':'#7c3aed'}" opacity="${intensity*0.4}" transform="rotate(${rot},${tx},${ty})">${corruptTexts[ti]}</text>`;
    }
  }
  corruptEl.innerHTML = corrupt;

  // Rolling scan bar (VHS tracking line, visible more during glitch)
  let roll = '';
  // Bar position cycles with period 90 (divides 180)
  const rollY = -60 + ((lt % 90) / 90) * 140;
  const rollOp = inGlitch ? 0.15 + intensity * 0.15 : 0.03;
  roll += `<rect x="-60" y="${rollY}" width="120" height="2" fill="#22AACC" opacity="${rollOp}"/>`;
  roll += `<rect x="-60" y="${rollY + 2}" width="120" height="4" fill="rgba(34,170,204,0.02)"/>`;
  rollbarEl.innerHTML = roll;

  // Enhanced scanlines visibility during glitch
  if (inGlitch) {
    scanlineDiv.style.background = `repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,${0.05 + intensity * 0.1}) 2px,rgba(0,0,0,${0.05 + intensity * 0.1}) 4px)`;
  } else {
    scanlineDiv.style.background = 'repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.05) 2px,rgba(0,0,0,0.05) 4px)';
  }

  // Brief flicker to near-black for 1-2 frames at peak glitch
  if (peakGlitch) {
    blackoutEl.innerHTML = `<rect x="-60" y="-60" width="120" height="120" fill="#0e1420" opacity="0.85"/>`;
  } else {
    blackoutEl.innerHTML = '';
  }
});
</script>
</body>
</html>
