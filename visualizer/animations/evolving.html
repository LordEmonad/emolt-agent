<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMOLT â€” Evolving</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0e1420;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden}
  .label{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:#7c3aed;font-family:monospace;font-size:14px;opacity:0.6}
</style>
</head>
<body>
<svg width="400" height="420" viewBox="-60 -80 120 150">
  <defs>
    <radialGradient id="glow" cx="50%" cy="45%" r="50%">
      <stop offset="0%" stop-color="#7c3aed" stop-opacity="0.15"/>
      <stop offset="100%" stop-color="#0e1420" stop-opacity="0"/>
    </radialGradient>
    <radialGradient id="auraGlow" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="#7c3aed" stop-opacity="0.2"/>
      <stop offset="50%" stop-color="#22AACC" stop-opacity="0.08"/>
      <stop offset="100%" stop-color="#0e1420" stop-opacity="0"/>
    </radialGradient>
    <filter id="levelGlow">
      <feGaussianBlur stdDeviation="2" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
  <circle cx="0" cy="0" r="65" fill="url(#glow)"/>
  <g id="aura"></g>
  <g id="dna"></g>
  <g id="lob"></g>
  <g id="energy"></g>
  <g id="xpbar"></g>
  <g id="level"></g>
  <g id="levelBurst"></g>
</svg>
<div class="label">evolving</div>
<script src="lobster.js"></script>
<script>
// GIF loop: 300 ticks = 5s at 60fps
const LOOP = 300;
const PULSE_PERIOD = 60;  // 5 pulse cycles per 300
const RISE_PERIOD = 150;  // 2 rise cycles per 300
const el = document.getElementById('lob');
const dnaEl = document.getElementById('dna');
const energyEl = document.getElementById('energy');
const levelEl = document.getElementById('level');
const auraEl = document.getElementById('aura');
const xpbarEl = document.getElementById('xpbar');
const levelBurstEl = document.getElementById('levelBurst');

// Pre-generate energy particles: one every 4 ticks = 75 per loop
const N_ENERGY = 75;
const energyParts = [];
for (let i = 0; i < N_ENERGY; i++) {
  const rng = mulberry32(i * 4517 + 19);
  energyParts.push({
    spawnT: i * 4,
    x0: (rng() - 0.5) * 30,
    vy: -0.8 - rng() * 0.6,
    color: ['#7c3aed','#22AACC','#F5D831'][Math.floor(rng() * 3)],
    lifetime: 50,
    // Comet tail parameters
    tailAngle: rng() * 0.3
  });
}

// LEVEL UP timing: appears at lt 240..285
const LEVEL_START = 240;
const LEVEL_END = 285;

startLoop(t => {
  const lt = t % LOOP;

  // Pulsing/growing effect with exact-period oscillations
  const pulse = 1 + Math.sin(lt * 2 * Math.PI / PULSE_PERIOD) * 0.03;
  const rise = Math.sin(lt * 2 * Math.PI / RISE_PERIOD) * 2;

  el.innerHTML = '<g transform="translate(0,' + rise + ') scale(' + pulse + ')">' +
    drawLobster({ t: lt, mood: 'happy' }) + '</g>';

  // Glowing aura that intensifies during LEVEL UP phase
  const inLevelPhase = lt >= LEVEL_START && lt < LEVEL_END;
  const levelP = inLevelPhase ? (lt - LEVEL_START) / (LEVEL_END - LEVEL_START) : 0;
  const auraOp = inLevelPhase ? 0.15 + levelP * 0.3 : 0.05 + Math.sin(lt * 2 * Math.PI / 60) * 0.03;
  const auraR = inLevelPhase ? 40 + levelP * 10 : 35 + Math.sin(lt * 2 * Math.PI / 60) * 3;
  let auraSvg = `<circle cx="0" cy="0" r="${auraR}" fill="url(#auraGlow)" opacity="${auraOp}"/>`;
  auraEl.innerHTML = auraSvg;

  // DNA helix with larger nodes and connecting rungs
  let dna = '';
  const helixPoints = 30;
  for (let i = 0; i < helixPoints; i++) {
    const y = -50 + i * (100 / helixPoints);
    const phase = y * 0.08 + lt * Math.PI / 75;
    const x1 = Math.cos(phase) * 20;
    const x2 = Math.cos(phase + Math.PI) * 20;
    const z1 = Math.sin(phase);
    const z2 = Math.sin(phase + Math.PI);
    const op1 = 0.18 + z1 * 0.12;
    const op2 = 0.18 + z2 * 0.12;
    const sz = 1.6 + z1 * 0.4; // larger nodes
    const colors = ['#7c3aed','#22AACC','#6ECB3C','#F5D831'];
    const c = colors[i % colors.length];

    // Draw nodes
    if (z1 > 0) dna += '<circle cx="' + x1 + '" cy="' + y + '" r="' + sz + '" fill="' + c + '" opacity="' + op1 + '"/>';
    if (z2 > 0) dna += '<circle cx="' + x2 + '" cy="' + y + '" r="' + sz + '" fill="' + c + '" opacity="' + op2 + '"/>';

    // Connecting rungs (base-pair bridges) -- more visible, every 2 nodes
    if (i % 2 === 0) {
      const rungOp = 0.1 + Math.abs(z1) * 0.08;
      const rungW = 0.4 + (1 - Math.abs(z1)) * 0.2;
      dna += '<line x1="' + x1 + '" y1="' + y + '" x2="' + x2 + '" y2="' + y + '" stroke="' + c + '" stroke-width="' + rungW + '" opacity="' + rungOp + '"/>';
      // Mid-rung mark for base-pair visual
      const midX = (x1 + x2) / 2;
      dna += '<circle cx="' + midX + '" cy="' + y + '" r="0.5" fill="' + c + '" opacity="' + (rungOp * 0.6) + '"/>';
    }
  }
  dnaEl.innerHTML = dna;

  // Rising energy particles with comet tails (3 sub-circles behind each)
  let energy = '';
  energyParts.forEach(p => {
    const age = particleAge(lt, p.spawnT, p.lifetime, LOOP);
    if (age >= 0) {
      const x = p.x0 + Math.sin(age / 6) * 4;
      const y = 40 + p.vy * age;
      const op = (1 - age / 50) * 0.4;
      // Comet tail (3 trailing dots)
      for (let ti = 1; ti <= 3; ti++) {
        const tailY = y - p.vy * ti * 1.2; // behind = opposite of velocity
        const tailX = x - Math.sin((age - ti * 1.2) / 6) * 4 + Math.sin(age / 6) * 4; // approx
        const tailOp = op * (1 - ti * 0.3);
        const tailR = 0.6 - ti * 0.12;
        if (tailR > 0.1) {
          energy += '<circle cx="' + (x + (tailX - x) * 0.3) + '" cy="' + (y + ti * 1.5) + '" r="' + tailR + '" fill="' + p.color + '" opacity="' + tailOp + '"/>';
        }
      }
      // Main particle
      energy += '<circle cx="' + x + '" cy="' + y + '" r="0.8" fill="' + p.color + '" opacity="' + op + '"/>';
    }
  });
  energyEl.innerHTML = energy;

  // XP progress bar at bottom (fills over the loop)
  const xpProgress = lt / LOOP;
  const barY = 60;
  const barW = 80;
  const barH = 2;
  let xpSvg = '';
  // Background bar
  xpSvg += `<rect x="${-barW/2}" y="${barY}" width="${barW}" height="${barH}" rx="1" fill="#1a1a2e" opacity="0.5"/>`;
  // Fill bar
  const fillW = barW * xpProgress;
  if (fillW > 0.5) {
    xpSvg += `<rect x="${-barW/2}" y="${barY}" width="${fillW}" height="${barH}" rx="1" fill="#7c3aed" opacity="0.6"/>`;
    // Glow at leading edge
    xpSvg += `<circle cx="${-barW/2 + fillW}" cy="${barY + barH/2}" r="1.5" fill="#22AACC" opacity="${0.3 + Math.sin(lt * 2 * Math.PI / 30) * 0.15}"/>`;
  }
  // "XP" label
  xpSvg += `<text x="${-barW/2 - 5}" y="${barY + barH + 0.5}" text-anchor="end" font-family="monospace" font-size="2.5" fill="#7c3aed" opacity="0.35">XP</text>`;
  xpbarEl.innerHTML = xpSvg;

  // Level up text with flash/burst effect
  const lvlCycle = lt % 300;
  if (lvlCycle > LEVEL_START && lvlCycle < LEVEL_END) {
    const p = (lvlCycle - LEVEL_START) / (LEVEL_END - LEVEL_START);
    const op = p < 0.2 ? p / 0.2 : p > 0.8 ? (1 - p) / 0.2 : 1;
    const y = -60 - p * 5;
    let lvlSvg = '<text x="0" y="' + y + '" text-anchor="middle" font-family="monospace" font-size="5" font-weight="bold" fill="#7c3aed" opacity="' + (op * 0.7) + '" filter="url(#levelGlow)">LEVEL UP</text>';
    levelEl.innerHTML = lvlSvg;
  } else {
    levelEl.innerHTML = '';
  }

  // Flash burst when LEVEL UP first appears (expanding ring + glow)
  let burstSvg = '';
  if (lvlCycle >= LEVEL_START && lvlCycle < LEVEL_START + 15) {
    const ba = lvlCycle - LEVEL_START;
    const burstR = 3 + ba * 3;
    const burstOp = (1 - ba / 15) * 0.5;
    burstSvg += `<circle cx="0" cy="-62" r="${burstR}" fill="none" stroke="#7c3aed" stroke-width="1" opacity="${burstOp}"/>`;
    burstSvg += `<circle cx="0" cy="-62" r="${burstR * 0.5}" fill="#fff" opacity="${burstOp * 0.3}"/>`;
    // Brief radial lines
    if (ba < 8) {
      for (let i = 0; i < 6; i++) {
        const ra = (i / 6) * Math.PI * 2;
        const r1 = burstR + 2;
        const r2 = burstR + 5;
        burstSvg += `<line x1="${Math.cos(ra)*r1}" y1="${-62+Math.sin(ra)*r1}" x2="${Math.cos(ra)*r2}" y2="${-62+Math.sin(ra)*r2}" stroke="#F5D831" stroke-width="0.5" opacity="${(1-ba/8)*0.4}"/>`;
      }
    }
  }
  levelBurstEl.innerHTML = burstSvg;
});
</script>
</body>
</html>
