<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>EMOLT</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap');

  :root {
    --bg:          #08080c;
    --bg-raised:   #0c0c12;
    --bg-surface:  #111118;
    --bg-hover:    #17171f;
    --bg-input:    #0e0e15;
    --border:      #1a1a28;
    --border-hover:#262640;
    --text:        #e0e0ee;
    --text-sec:    #8080a0;
    --text-muted:  #50506a;
    --text-ghost:  #2a2a40;

    --accent:      #6366f1;
    --accent-lt:   #818cf8;
    --accent-glow: rgba(99,102,241,0.10);
    --accent-glow2:rgba(99,102,241,0.05);

    --dispatch:    #ef4444;
    --dispatch-lt: #f87171;
    --dispatch-glow:rgba(239,68,68,0.10);

    --dev:         #10b981;
    --dev-lt:      #34d399;
    --dev-glow:    rgba(16,185,129,0.10);

    /* active mode colors — overridden by body class */
    --mode:        var(--accent);
    --mode-lt:     var(--accent-lt);
    --mode-glow:   var(--accent-glow);

    --joy:#facc15; --trust:#4ade80; --fear:#22c55e; --surprise:#38bdf8;
    --sadness:#6366f1; --disgust:#c084fc; --anger:#f87171; --anticipation:#fb923c;

    --sidebar-w: 252px;
    --safe-b: env(safe-area-inset-bottom, 0px);

    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-full: 9999px;
  }

  .mode-dispatch {
    --mode: var(--dispatch); --mode-lt: var(--dispatch-lt); --mode-glow: var(--dispatch-glow);
  }
  .mode-dev {
    --mode: var(--dev); --mode-lt: var(--dev-lt); --mode-glow: var(--dev-glow);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; overflow:hidden; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
    font-size: 14px;
    display: flex;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  code, .mono { font-family: 'JetBrains Mono', monospace; }

  ::selection { background: rgba(99,102,241,0.3); color: #fff; }
  .mode-dispatch ::selection { background: rgba(239,68,68,0.3); }
  .mode-dev ::selection { background: rgba(16,185,129,0.3); }

  /* ═══════════════════════════════════════════
     SCROLLBAR — ultra minimal
  ═══════════════════════════════════════════ */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

  /* ═══════════════════════════════════════════
     SIDEBAR
  ═══════════════════════════════════════════ */
  .sidebar {
    width: var(--sidebar-w);
    background: var(--bg-raised);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    z-index: 20;
    transition: transform 0.25s cubic-bezier(0.16,1,0.3,1);
  }

  .sidebar-header {
    padding: 16px 16px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .sidebar-logo {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 500;
    letter-spacing: 3px; color: var(--text);
  }
  .sidebar-logo span {
    color: var(--text-muted);
    font-weight: 300;
    font-size: 10px;
    letter-spacing: 1px;
    margin-left: 2px;
  }

  .sidebar-ring {
    width: 6px; height: 6px; border-radius: 50%;
    background: #22c55e;
    box-shadow: 0 0 8px rgba(34,197,94,0.4);
    animation: breathe 3s ease-in-out infinite;
  }
  @keyframes breathe { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  .sidebar-actions {
    padding: 4px 10px 10px;
    display: flex;
    gap: 5px;
  }

  .sidebar-btn {
    flex: 1;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; letter-spacing: 1px; font-weight: 500;
    padding: 7px 4px;
    border-radius: var(--radius-sm);
    border: 1px solid transparent;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.15s;
  }
  .sidebar-btn:hover {
    background: var(--bg-surface);
    color: var(--text-sec);
    border-color: var(--border);
  }
  .sidebar-btn .btn-dot {
    width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0;
    opacity: 0.7;
  }
  .sidebar-btn:hover .btn-dot { opacity: 1; }

  .sidebar-divider {
    height: 1px;
    background: var(--border);
    margin: 0 12px 6px;
    opacity: 0.5;
  }

  .sidebar-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 8px;
  }

  .sidebar-item {
    padding: 9px 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.12s;
    margin-bottom: 1px;
    display: flex;
    align-items: center;
    gap: 9px;
    position: relative;
    border: 1px solid transparent;
  }
  .sidebar-item:hover { background: var(--bg-surface); }
  .sidebar-item.active {
    background: var(--bg-surface);
    border-color: var(--border);
  }

  .sidebar-item-dot {
    width: 5px; height: 5px; border-radius: 50%;
    flex-shrink: 0;
  }

  .sidebar-item-info { flex: 1; min-width: 0; }

  .sidebar-item-label {
    font-size: 12px;
    color: var(--text-sec);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.3;
  }
  .sidebar-item.active .sidebar-item-label { color: var(--text); }

  .sidebar-item-type {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    letter-spacing: 0.5px;
    color: var(--text-ghost);
    text-transform: uppercase;
    margin-top: 1px;
  }

  .sidebar-item-close {
    display: none;
    width: 18px; height: 18px;
    border-radius: 4px;
    align-items: center; justify-content: center;
    font-size: 12px;
    color: var(--text-ghost);
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.12s;
  }
  .sidebar-item:hover .sidebar-item-close { display: flex; }
  .sidebar-item-close:hover { background: rgba(239,68,68,0.12); color: var(--anger); }

  .sidebar-item-pin {
    display: none;
    width: 18px; height: 18px;
    border-radius: 4px;
    align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    color: var(--text-ghost);
    transition: all 0.12s;
  }
  .sidebar-item-pin svg { width: 11px; height: 11px; fill: none; stroke: currentColor; stroke-width: 1.6; stroke-linecap: round; stroke-linejoin: round; }
  .sidebar-item:hover .sidebar-item-pin { display: flex; }
  .sidebar-item-pin.pinned { display: flex; color: var(--accent); }
  .sidebar-item-pin.pinned svg { fill: var(--accent); fill-opacity: 0.2; }
  .sidebar-item-pin:hover { background: var(--accent-glow); color: var(--accent-lt); }

  .sidebar-rename-input {
    background: var(--bg-input);
    border: 1px solid var(--mode);
    color: var(--text);
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 5px;
    outline: none;
    width: 100%;
    font-family: 'Inter', sans-serif;
  }

  .sidebar-empty {
    text-align: center;
    padding: 28px 12px;
    font-size: 11px;
    color: var(--text-ghost);
    letter-spacing: 0.5px;
  }

  .sidebar-footer {
    padding: 8px 10px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 2px;
  }

  .sfbtn {
    background: none; border: none;
    color: var(--text-ghost);
    width: 32px; height: 32px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.12s;
  }
  .sfbtn:hover { color: var(--text-sec); background: var(--bg-surface); }
  .sfbtn.active { color: var(--mode); }
  .sfbtn svg { width: 15px; height: 15px; fill: none; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }

  /* ═══════════════════════════════════════════
     MAIN AREA
  ═══════════════════════════════════════════ */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    position: relative;
  }

  /* Header */
  .header {
    background: var(--bg-raised);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    position: relative;
  }
  .header::after {
    content: '';
    position: absolute; bottom: -1px; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--mode) 30%, var(--mode-lt) 50%, var(--mode) 70%, transparent 100%);
    opacity: 0.25;
  }

  .header-left { display: flex; align-items: center; gap: 10px; }

  .header-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px; font-weight: 500;
    letter-spacing: 2.5px; color: var(--text-sec);
  }
  .header-title .mode-label {
    color: var(--mode);
    font-weight: 500;
  }

  .header-actions { display: flex; align-items: center; gap: 4px; }

  .hbtn {
    background: none; border: 1px solid transparent;
    color: var(--text-ghost);
    width: 32px; height: 32px; border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.15s;
  }
  .hbtn:hover { color: var(--text-sec); background: var(--bg-surface); border-color: var(--border); }
  .hbtn svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }

  .sidebar-toggle { display: none; }

  /* Emotion bar */
  .emo-bar {
    background: var(--bg-raised);
    border-bottom: 1px solid var(--border);
    padding: 5px 20px;
    display: flex; align-items: center; gap: 10px;
    flex-shrink: 0;
    min-height: 28px;
  }
  .emo-track { flex:1; height:3px; border-radius:2px; display:flex; overflow:hidden; background:var(--bg); }
  .emo-seg { height:100%; transition: flex-basis 0.8s cubic-bezier(0.16,1,0.3,1); }
  .emo-seg:first-child { border-radius:2px 0 0 2px; }
  .emo-seg:last-child { border-radius:0 2px 2px 0; }
  .emo-label { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-sec); white-space:nowrap; flex-shrink:0; letter-spacing:0.3px; }
  .emo-label-dominant { color: var(--mode); }
  .emo-placeholder { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); }

  /* ═══════════════════════════════════════════
     MESSAGES
  ═══════════════════════════════════════════ */
  .messages-wrap { flex: 1; overflow: hidden; position: relative; }

  .messages {
    height: 100%;
    overflow-y: auto; overflow-x: hidden;
    padding: 24px 24px 16px;
    display: flex; flex-direction: column; gap: 16px;
    overscroll-behavior: contain;
  }

  .msg { max-width: 72%; animation: msgIn 0.3s cubic-bezier(0.16,1,0.3,1); }
  @keyframes msgIn {
    from { opacity:0; transform:translateY(6px) scale(0.99); }
    to { opacity:1; transform:translateY(0) scale(1); }
  }
  .msg.user { align-self: flex-end; }
  .msg.emolt { align-self: flex-start; }

  .msg-bubble {
    padding: 12px 16px; line-height: 1.7;
    white-space: pre-wrap; word-break: break-word;
    font-size: 14px; letter-spacing: 0.01em;
  }

  .msg.user .msg-bubble {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg) var(--radius-lg) 4px var(--radius-lg);
    color: var(--text);
  }

  .msg.emolt .msg-bubble {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
    border-left: 2px solid var(--border-hover);
    transition: border-left-color 0.5s;
  }

  /* Dev mode: emolt bubbles support markdown rendering */
  .mode-dev .msg.emolt .msg-bubble { font-size: 13.5px; }
  .mode-dev .msg.emolt .msg-bubble pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    margin: 8px 0;
    overflow-x: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    line-height: 1.6;
    color: var(--text-sec);
  }
  .mode-dev .msg.emolt .msg-bubble code {
    background: var(--bg);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 12px;
    color: var(--dev-lt);
  }
  .mode-dev .msg.emolt .msg-bubble pre code {
    background: none;
    padding: 0;
    color: var(--text-sec);
  }
  .mode-dev .msg.emolt .msg-bubble h1,
  .mode-dev .msg.emolt .msg-bubble h2,
  .mode-dev .msg.emolt .msg-bubble h3 {
    color: var(--text);
    margin: 12px 0 6px;
    font-size: 14px;
    font-weight: 600;
  }
  .mode-dev .msg.emolt .msg-bubble ul,
  .mode-dev .msg.emolt .msg-bubble ol {
    padding-left: 20px;
    margin: 6px 0;
  }
  .mode-dev .msg.emolt .msg-bubble li {
    margin: 3px 0;
    line-height: 1.6;
  }
  .mode-dev .msg.emolt .msg-bubble strong { color: var(--text); font-weight: 600; }
  .mode-dev .msg.emolt .msg-bubble em { color: var(--text-sec); }

  /* Dispatch mode user bubbles */
  .mode-dispatch .msg.user .msg-bubble {
    border-color: #2a1818;
  }

  /* Dev mode user bubbles */
  .mode-dev .msg.user .msg-bubble {
    border-color: #1a2a20;
  }

  .msg-meta { display:flex; align-items:center; gap:6px; margin-top:4px; padding:0 6px; }
  .msg.user .msg-meta { justify-content: flex-end; }
  .msg-time { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); letter-spacing:0.3px; }

  /* Internals */
  .internals-toggle {
    display:inline-flex; align-items:center; gap:5px;
    font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost);
    cursor:pointer; user-select:none; padding:3px 7px; border-radius:5px;
    transition:all 0.15s; letter-spacing:0.3px;
  }
  .internals-toggle:hover { color:var(--text-muted); background:var(--bg-surface); }
  .internals-arrow { display:inline-block; transition:transform 0.2s ease; font-size:7px; }
  .internals-arrow.open { transform:rotate(90deg); }
  .internals-dur { opacity:0.5; margin-left:2px; }
  .internals-panel { display:grid; grid-template-rows:0fr; transition:grid-template-rows 0.3s cubic-bezier(0.16,1,0.3,1); }
  .internals-panel.open { grid-template-rows:1fr; }
  .internals-inner { overflow:hidden; }
  .internals-content {
    margin-top:6px; padding:10px 12px;
    background:var(--bg); border:1px solid var(--border); border-radius:var(--radius-sm);
    font-size:12px; line-height:1.5;
  }
  .internals-section { margin-bottom:6px; }
  .internals-section:last-child { margin-bottom:0; }
  .internals-label { font-family:'JetBrains Mono',monospace; font-size:8px; text-transform:uppercase; letter-spacing:1.5px; color:var(--mode); margin-bottom:2px; opacity:0.5; }
  .internals-text { color:var(--text-sec); font-size:12px; }

  /* ═══════════════════════════════════════════
     WELCOME
  ═══════════════════════════════════════════ */
  .welcome {
    flex:1; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    gap:20px; text-align:center; padding:40px 24px; min-height:100%;
  }

  .welcome-ring {
    width: 64px; height: 64px; border-radius: 50%;
    border: 1.5px solid var(--border-hover);
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .welcome-ring::before {
    content: '';
    position: absolute; inset: -6px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--mode-glow) 0%, transparent 70%);
    animation: ringGlow 4s ease-in-out infinite;
  }
  @keyframes ringGlow {
    0%,100% { opacity:0.6; transform:scale(1); }
    50% { opacity:1; transform:scale(1.08); }
  }

  .welcome-ring-inner {
    width: 24px; height: 24px; border-radius: 50%;
    background: linear-gradient(135deg, var(--mode), var(--mode-lt));
    opacity: 0.6;
    z-index: 1;
  }

  .welcome-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 26px; font-weight: 300; letter-spacing: 8px; color: var(--text);
  }
  .welcome-title .wm {
    background: linear-gradient(135deg, var(--mode), var(--mode-lt));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .welcome-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; letter-spacing: 2px;
    color: var(--text-ghost);
    text-transform: uppercase;
  }

  .welcome-desc {
    max-width: 400px; line-height: 1.7;
    font-size: 13px; color: var(--text-muted);
    letter-spacing: 0.01em;
  }

  .welcome-starters {
    display: flex; flex-wrap: wrap; gap: 6px;
    justify-content: center; max-width: 440px;
    margin-top: 4px;
  }

  .starter {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-sec);
    padding: 8px 16px;
    border-radius: var(--radius-full);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
    font-family: 'Inter', sans-serif;
    letter-spacing: 0.01em;
  }
  .starter:hover {
    border-color: var(--mode);
    color: var(--text);
    background: var(--mode-glow);
    transform: translateY(-1px);
  }
  .starter:active { transform: translateY(0) scale(0.98); }

  /* ═══════════════════════════════════════════
     DISPATCH CARDS
  ═══════════════════════════════════════════ */
  .plan-card { align-self:flex-start; max-width:88%; animation:msgIn 0.3s cubic-bezier(0.16,1,0.3,1); }
  .plan-card-inner {
    background: var(--bg-raised);
    border: 1px solid #3a1818;
    border-left: 3px solid var(--dispatch);
    border-radius: var(--radius-lg);
    padding: 18px;
    font-size: 13px; line-height: 1.6;
  }
  .plan-card-inner.pending { animation: shimmer 2.5s ease-in-out infinite; }
  @keyframes shimmer {
    0%,100% { box-shadow:0 0 0 0 rgba(239,68,68,0); }
    50% { box-shadow:0 0 20px 2px rgba(239,68,68,0.08); }
  }
  .plan-card-header {
    display:flex; align-items:center; gap:8px; margin-bottom:14px;
    font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:500;
    letter-spacing:1.5px; color:var(--dispatch);
  }
  .plan-card-emoji { font-size:16px; }
  .plan-card-summary { color:var(--text); margin-bottom:8px; }
  .plan-card-emotional { color:var(--text-sec); font-style:italic; font-size:12px; margin-bottom:8px; }
  .plan-card-params {
    font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--text-sec);
    background:var(--bg); padding:10px 12px; border-radius:var(--radius-sm);
    margin-bottom:10px; border: 1px solid var(--border);
  }
  .plan-card-risks { color:var(--text-muted); font-size:11px; margin-bottom:14px; padding-left:10px; border-left:2px solid #2a1818; }
  .plan-card-actions { display:flex; gap:8px; }
  .plan-card-btn {
    font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:1px;
    padding:8px 22px; border-radius:var(--radius-sm); border:none;
    cursor:pointer; transition:all 0.15s; font-weight:500;
  }
  .plan-card-btn.approve {
    background: linear-gradient(135deg,var(--dispatch),var(--dispatch-lt));
    color:#fff; box-shadow:0 0 16px rgba(239,68,68,0.2);
  }
  .plan-card-btn.approve:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(239,68,68,0.3); }
  .plan-card-btn.reject { background:var(--bg); color:var(--text-sec); border:1px solid var(--border); }
  .plan-card-btn.reject:hover { color:var(--text); border-color:var(--border-hover); }
  .plan-card-btn:disabled { opacity:0.3; cursor:not-allowed; }

  /* Dispatch log entries */
  .dispatch-entry { align-self:flex-start; max-width:88%; animation:msgIn 0.2s cubic-bezier(0.16,1,0.3,1); }
  .dispatch-entry-inner {
    padding:9px 14px; border-radius:var(--radius-md);
    font-family:'JetBrains Mono',monospace; font-size:11px; line-height:1.55;
  }
  .dispatch-entry.type-step .dispatch-entry-inner { background:var(--bg-surface); border:1px solid var(--border); color:var(--text-sec); }
  .dispatch-entry.type-thought .dispatch-entry-inner { background:transparent; border:1px solid var(--border); color:var(--text-muted); font-style:italic; font-size:10px; white-space:pre-wrap; }
  .dispatch-entry.type-action .dispatch-entry-inner { background:var(--bg-surface); border:1px solid #3a1818; border-left:2px solid var(--dispatch); color:var(--text); }
  .dispatch-entry.type-error .dispatch-entry-inner { background:#120808; border:1px solid #3a1414; color:var(--dispatch); }
  .dispatch-entry.type-result .dispatch-entry-inner { background:var(--bg-surface); border:1px solid #2a2a14; border-left:2px solid var(--joy); color:var(--joy); }
  .dispatch-entry.type-plan .dispatch-entry-inner { background:var(--bg-surface); border:1px solid var(--border); color:var(--text-sec); font-size:10px; }
  .dispatch-entry.type-approval .dispatch-entry-inner { background:var(--bg-surface); border:1px solid #1a2a1a; border-left:2px solid var(--trust); color:var(--trust); font-size:10px; }
  .dispatch-entry.type-complete .dispatch-entry-inner { background:var(--bg-surface); border:1px solid var(--border); color:var(--text); font-size:10px; }
  .dispatch-entry-ts { font-size:8px; color:var(--text-ghost); margin-top:3px; padding:0 4px; letter-spacing:0.3px; font-family:'JetBrains Mono',monospace; }

  /* Result card */
  .result-card { align-self:flex-start; max-width:88%; animation:msgIn 0.3s cubic-bezier(0.16,1,0.3,1); }
  .result-card-inner { background:var(--bg-raised); border-radius:var(--radius-lg); padding:18px; font-size:13px; line-height:1.6; }
  .result-card-inner.success { border:1px solid #1a2a1a; border-left:3px solid var(--trust); }
  .result-card-inner.failure { border:1px solid #2a1818; border-left:3px solid var(--dispatch); }
  .result-card-inner.killed { border:1px solid #2a2010; border-left:3px solid var(--anticipation); }
  .result-card-header { font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:500; letter-spacing:1.5px; margin-bottom:12px; }
  .result-card-inner.success .result-card-header { color:var(--trust); }
  .result-card-inner.failure .result-card-header { color:var(--dispatch); }
  .result-card-inner.killed .result-card-header { color:var(--anticipation); }
  .result-card-summary { color:var(--text); margin-bottom:8px; }
  .result-card-reflection { color:var(--text-sec); font-style:italic; font-size:12px; margin-bottom:10px; }
  .result-card-stats {
    font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--text-muted);
    background:var(--bg); padding:14px; border-radius:var(--radius-sm); border:1px solid var(--border);
  }
  .result-card-stats .stat-section { margin-bottom:8px; }
  .result-card-stats .stat-section:last-child { margin-bottom:0; }
  .result-card-stats .stat-section-label { color:var(--text-sec); font-size:9px; letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
  .result-card-stats .stat-row { display:flex; justify-content:space-between; padding:2px 0; }
  .result-card-stats .stat-key { color:var(--text-sec); }
  .result-card-stats .stat-val { color:var(--text); }
  .result-card-stats .stat-val.positive { color:var(--trust); }
  .result-card-stats .stat-val.negative { color:var(--dispatch); }
  .result-card-stats .stat-divider { border-top:1px solid var(--border); margin:8px 0; }
  .result-card-stats .stat-actions { color:var(--text-muted); font-size:10px; word-break:break-all; line-height:1.6; margin-top:4px; }
  .result-card-stats .stat-actions span { background:var(--bg-raised); padding:1px 5px; border-radius:3px; margin:1px; display:inline-block; }

  /* ═══════════════════════════════════════════
     KILL SWITCH
  ═══════════════════════════════════════════ */
  .kill-btn {
    display:none;
    font-family:'JetBrains Mono',monospace; font-size:9px; font-weight:500;
    letter-spacing:1px; padding:5px 14px; border-radius:var(--radius-sm);
    border:1px solid rgba(239,68,68,0.3); background:rgba(239,68,68,0.08);
    color:#ff4444; cursor:pointer; transition:all 0.15s;
    animation: killPulse 2s ease-in-out infinite;
    white-space:nowrap;
  }
  .kill-btn.active { display:inline-flex; align-items:center; gap:5px; }
  @keyframes killPulse { 0%,100% { box-shadow:0 0 8px rgba(255,68,68,0.1); } 50% { box-shadow:0 0 20px rgba(255,68,68,0.2); } }
  .kill-btn:hover { background:rgba(239,68,68,0.18); border-color:rgba(239,68,68,0.5); }
  .kill-btn:active { transform:scale(0.96); }

  /* ═══════════════════════════════════════════
     TYPING + ABORTED
  ═══════════════════════════════════════════ */
  .typing { align-self:flex-start; display:none; animation:msgIn 0.2s ease-out; }
  .typing.active { display:flex; align-items:center; gap:8px; }
  .typing-dots {
    display:flex; gap:3px; padding:12px 16px;
    background:var(--bg-raised); border:1px solid var(--border);
    border-radius:var(--radius-lg) var(--radius-lg) var(--radius-lg) 4px;
    border-left:2px solid var(--mode);
  }
  .typing-dot {
    width:4px; height:4px; border-radius:50%;
    background:var(--mode);
    animation:dotPulse 1.4s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay:0.2s; }
  .typing-dot:nth-child(3) { animation-delay:0.4s; }
  @keyframes dotPulse { 0%,80%,100% { transform:scale(0.5); opacity:0.2; } 40% { transform:scale(1); opacity:1; } }
  .typing-elapsed { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); font-variant-numeric:tabular-nums; }

  .msg-aborted { align-self:flex-start; font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--text-ghost); font-style:italic; padding:4px 8px; animation:msgIn 0.2s ease-out; }

  /* ═══════════════════════════════════════════
     INPUT AREA — floating pill
  ═══════════════════════════════════════════ */
  .input-area {
    padding: 10px 20px 14px;
    padding-bottom: calc(14px + var(--safe-b));
    flex-shrink: 0;
    background: linear-gradient(to top, var(--bg) 60%, transparent);
  }

  .input-row {
    display: flex;
    gap: 0;
    align-items: flex-end;
    max-width: 680px;
    margin: 0 auto;
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: 6px 6px 6px 18px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-row:focus-within {
    border-color: var(--mode);
    box-shadow: 0 0 0 3px var(--mode-glow), 0 8px 32px rgba(0,0,0,0.3);
  }

  textarea {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    padding: 8px 10px 8px 0;
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
    font-size: 14px;
    resize: none;
    outline: none;
    line-height: 1.5;
    min-height: 38px;
    max-height: 140px;
    letter-spacing: 0.01em;
  }
  textarea::placeholder { color: var(--text-ghost); }

  .send-btn {
    background: linear-gradient(135deg, var(--mode), var(--mode-lt));
    border: none; color: #fff;
    width: 38px; height: 38px;
    border-radius: 14px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
    flex-shrink: 0;
  }
  .send-btn:active { transform: scale(0.9); }
  .send-btn:disabled { background: var(--bg-surface); color: var(--text-ghost); cursor: not-allowed; opacity: 0.5; }
  .send-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }
  .send-btn.stop-mode {
    background: #ef4444 !important;
    animation: stopPulse 1.5s ease-in-out infinite;
  }
  @keyframes stopPulse { 0%,100% { box-shadow:0 0 6px rgba(239,68,68,0.2); } 50% { box-shadow:0 0 18px rgba(239,68,68,0.4); } }

  /* ═══════════════════════════════════════════
     LOG OVERLAY
  ═══════════════════════════════════════════ */
  .log-overlay {
    display:none; position:fixed; inset:0;
    background:rgba(4,4,8,0.85); z-index:100;
    backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
  }
  .log-overlay.open { display:flex; align-items:center; justify-content:center; animation:fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }

  .log-panel {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    width: 90%; max-width: 740px; max-height: 78vh;
    display: flex; flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }

  .log-top { padding:14px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .log-top h3 { font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:500; letter-spacing:2px; color:var(--text-sec); }
  .log-top-right { display:flex; align-items:center; gap:10px; }
  .log-count { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); }
  .log-close {
    background:none; border:1px solid var(--border); color:var(--text-sec);
    width:26px; height:26px; border-radius:var(--radius-sm);
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    font-size:14px; transition:all 0.15s;
  }
  .log-close:hover { background:var(--bg-surface); color:var(--text); }
  .log-body { overflow-y:auto; flex:1; overscroll-behavior:contain; }
  .log-entry { padding:14px 18px; border-bottom:1px solid var(--border); font-size:12px; line-height:1.6; transition: background 0.1s; }
  .log-entry:last-child { border-bottom:none; }
  .log-entry:hover { background: var(--bg-surface); }
  .log-meta { display:flex; justify-content:space-between; margin-bottom:6px; }
  .log-ts, .log-dur { font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); }
  .log-user-msg { color:var(--surprise); margin-bottom:3px; }
  .log-emolt-msg { color:var(--joy); margin-bottom:3px; }
  .log-user-msg::before { content:'you  '; font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); }
  .log-emolt-msg::before { content:'emolt  '; font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text-ghost); }
  .log-internal { color:var(--text-ghost); font-style:italic; font-size:11px; margin-top:2px; }
  .log-empty { color:var(--text-ghost); text-align:center; padding:48px 16px; font-size:12px; }
  .log-tabs { display:flex; border-bottom:1px solid var(--border); }
  .log-tab {
    flex:1; text-align:center; padding:10px;
    font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:1px;
    color:var(--text-ghost); cursor:pointer;
    border-bottom:2px solid transparent; transition:all 0.15s;
  }
  .log-tab:hover { color:var(--text-sec); background:var(--bg-surface); }
  .log-tab.active { color:var(--mode); border-bottom-color:var(--mode); }

  /* ═══════════════════════════════════════════
     DEV MODE — badge in sidebar
  ═══════════════════════════════════════════ */
  .dev-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 7px;
    letter-spacing: 1px;
    color: var(--dev);
    background: var(--dev-glow);
    border: 1px solid rgba(16,185,129,0.2);
    padding: 2px 6px;
    border-radius: var(--radius-full);
    font-weight: 500;
  }

  /* ═══════════════════════════════════════════
     RESPONSIVE
  ═══════════════════════════════════════════ */
  @media (min-width:769px) {
    .send-btn:hover:not(:disabled):not(.stop-mode) {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px color-mix(in srgb, var(--mode) 30%, transparent);
    }
  }

  @media (max-width:768px) {
    .sidebar {
      position: fixed; top:0; left:0; bottom:0;
      transform: translateX(-100%);
      z-index: 50;
      box-shadow: 4px 0 32px rgba(0,0,0,0.6);
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-toggle { display: flex; }
    .sidebar-overlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:40;
      backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);
    }
    .sidebar-overlay.open { display:block; }
    .msg { max-width:86%; }
    .welcome-title { font-size:20px; letter-spacing:5px; }
    .log-panel { width:100%; height:100%; max-height:100%; border-radius:0; border:none; }
    .input-row { padding: 5px 5px 5px 14px; border-radius: 16px; }
  }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-ring"></div>
    <div class="sidebar-logo">EMOLT <span>v13</span></div>
  </div>
  <div class="sidebar-actions">
    <button class="sidebar-btn" onclick="createSession('chat')">
      <div class="btn-dot" style="background:var(--accent)"></div> CHAT
    </button>
    <button class="sidebar-btn" onclick="createSession('dispatch')">
      <div class="btn-dot" style="background:var(--dispatch)"></div> DISPATCH
    </button>
    <button class="sidebar-btn" onclick="createSession('dev')">
      <div class="btn-dot" style="background:var(--dev)"></div> DEV
    </button>
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-list" id="sidebarList"></div>
  <div class="sidebar-footer">
    <button class="sfbtn" onclick="openLog()" title="logs">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
    </button>
    <button class="sfbtn" id="thinkBtn" onclick="toggleAllThinking()" title="toggle internals">
      <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
    </button>
  </div>
</div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- MAIN -->
<div class="main" id="main">
  <div class="header" id="header">
    <div class="header-left">
      <button class="hbtn sidebar-toggle" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="header-title" id="headerTitle">EMOLT <span class="mode-label">CHAT</span></div>
    </div>
    <div class="header-actions" id="headerActions">
      <button class="kill-btn" id="killBtn" onclick="killCurrentDispatch()">&#9632; KILL</button>
    </div>
  </div>

  <div class="emo-bar" id="emoBar">
    <span class="emo-placeholder">awaiting heartbeat</span>
  </div>

  <div class="messages-wrap" id="messagesWrap"></div>

  <div class="input-area">
    <div class="input-row">
      <textarea id="input" placeholder="say something..." rows="1" autofocus></textarea>
      <button class="send-btn" id="sendBtn" onclick="handleSendClick()">
        <svg id="sendIcon" viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        <svg id="stopIcon" viewBox="0 0 24 24" style="display:none"><rect x="6" y="6" width="12" height="12" rx="2" fill="currentColor" stroke="none"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- LOG OVERLAY -->
<div class="log-overlay" id="logOverlay" onclick="closeLog(event)">
  <div class="log-panel" onclick="event.stopPropagation()">
    <div class="log-top">
      <h3 id="logTitle">CONVERSATION LOG</h3>
      <div class="log-top-right">
        <span class="log-count" id="logCount"></span>
        <button class="log-close" onclick="closeLog()">&times;</button>
      </div>
    </div>
    <div class="log-tabs">
      <div class="log-tab active" onclick="switchLogTab('chat')">CHAT</div>
      <div class="log-tab" onclick="switchLogTab('dispatch')">DISPATCHES</div>
      <div class="log-tab" onclick="switchLogTab('dev')">DEV</div>
    </div>
    <div class="log-body" id="logBody"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════
const sessions = new Map();
let activeId = null;
let showAllThinking = false;
let currentLogTab = 'chat';

const $ = id => document.getElementById(id);
const inputEl = $('input');
const sendBtn = $('sendBtn');
const sendIcon = $('sendIcon');
const stopIcon = $('stopIcon');
const emoBar = $('emoBar');
const header = $('header');
const headerTitle = $('headerTitle');
const messagesWrap = $('messagesWrap');
const killBtn = $('killBtn');
const sidebarList = $('sidebarList');

const EMO_COLORS = { joy:'#facc15',trust:'#4ade80',fear:'#22c55e',surprise:'#38bdf8',sadness:'#6366f1',disgust:'#c084fc',anger:'#f87171',anticipation:'#fb923c' };
const EMO_ORDER = ['joy','trust','fear','surprise','sadness','disgust','anger','anticipation'];
const esc = s => { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; };
const fmtTime = ts => new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});

const MODE_LABELS = { chat:'CHAT', dispatch:'DISPATCH', dev:'DEV' };
const MODE_PLACEHOLDERS = { chat:'say something...', dispatch:'give EMOLT a mission...', dev:'what are we building...' };
const MODE_CLASSES = { chat:'', dispatch:'mode-dispatch', dev:'mode-dev' };

const WELCOME_CONFIG = {
  chat: {
    sub: 'full soul stack / real-time',
    desc: 'talk directly to the agent. every message passes through the soul stack, memory, and the emotional engine.',
    starters: ['how are you feeling right now', "what's on your mind", 'do you get tired of feeling things', 'what does anxiety feel like for you'],
  },
  dispatch: {
    sub: 'mission control',
    desc: 'send EMOLT into the world. give orders, approve plans, watch it unfold in real-time.',
    starters: ['go play chess', 'explore the reef', 'play chess — create a wager lobby', 'go on a reef adventure'],
  },
  dev: {
    sub: 'unrestricted / full access',
    desc: 'dev partner mode. plan features, debug issues, write code, architect systems. no character, no restrictions.',
    starters: ['what broke since last cycle', 'audit the emotion engine', 'walk me through the heartbeat loop', 'what should we build next'],
  },
};

// ═══════════════════════════════════════════
//  Simple markdown for dev mode
// ═══════════════════════════════════════════
function renderMarkdown(text) {
  let html = esc(text);
  // Code blocks
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) =>
    `<pre><code>${code.trim()}</code></pre>`
  );
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Bold
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Unordered lists
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
  // Numbered lists
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  // Paragraphs — double newlines become paragraph breaks (skip inside pre/ul)
  html = html.replace(/\n{2,}/g, '</p><p>');
  html = '<p>' + html + '</p>';
  // Clean up empty paragraphs and paragraphs wrapping block elements
  html = html.replace(/<p>\s*<\/p>/g, '');
  html = html.replace(/<p>\s*(<(?:pre|ul|ol|h[1-3]|div))/g, '$1');
  html = html.replace(/(<\/(?:pre|ul|ol|h[1-3]|div)>)\s*<\/p>/g, '$1');
  return html;
}

// ═══════════════════════════════════════════
//  SESSION MANAGEMENT
// ═══════════════════════════════════════════
function uid() { return Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6); }

function createSession(type, opts) {
  if (!opts?.silent) closeSidebar();
  const id = opts?.id || uid();
  const label = type === 'dev' ? 'Dev Session' : type === 'chat' ? 'New Chat' : 'New Dispatch';
  const cfg = WELCOME_CONFIG[type] || WELCOME_CONFIG.chat;

  const el = document.createElement('div');
  el.className = 'messages';
  el.innerHTML = `<div class="welcome">
    <div class="welcome-ring"><div class="welcome-ring-inner"></div></div>
    <div class="welcome-title">EMOLT <span class="wm">${MODE_LABELS[type]}</span></div>
    <div class="welcome-sub">${cfg.sub}</div>
    <div class="welcome-desc">${cfg.desc}</div>
    <div class="welcome-starters">${cfg.starters.map(s => `<div class="starter" onclick="useSt(this)">${s}</div>`).join('')}</div>
  </div>`;

  const sess = {
    id, type, label, el,
    serverSessionId: null,
    scrollPos: 0,
    sending: false,
    msgCount: 0,
    pinned: false,
    dispatchId: null,
    polling: null,
    lastSeenLogIdx: 0,
    dispatchDone: false,
    typingTimer: null,
    typingStart: 0,
  };

  sessions.set(id, sess);
  if (!opts?.silent) {
    renderSidebar();
    switchSession(id);
    saveSessions();
  }
  return sess;
}

function switchSession(id) {
  const sess = sessions.get(id);
  if (!sess) return;

  if (activeId && activeId !== id) {
    const prev = sessions.get(activeId);
    if (prev && prev.el.parentNode) {
      prev.scrollPos = prev.el.scrollTop;
      prev.el.remove();
    }
  }

  activeId = id;
  messagesWrap.appendChild(sess.el);
  sess.el.scrollTop = sess.scrollPos;

  // Theme
  document.body.className = MODE_CLASSES[sess.type] || '';
  headerTitle.innerHTML = `EMOLT <span class="mode-label">${MODE_LABELS[sess.type]}</span>`;
  inputEl.placeholder = MODE_PLACEHOLDERS[sess.type] || 'say something...';

  // Kill button
  killBtn.classList.toggle('active', sess.type === 'dispatch' && !!sess.dispatchId && !sess.dispatchDone);

  // Emo bar visibility
  if (sess.type === 'dev') {
    emoBar.innerHTML = '<span class="emo-placeholder" style="color:var(--dev)">DEV MODE</span>';
  } else {
    // Restore real emotion bar when switching away from dev
    if (emoBar.querySelector('.emo-placeholder')) {
      fetch('/api/state/emotions').then(r=>r.json()).then(d=>{if(d.emotionState)updateEmoBar(d.emotionState);}).catch(()=>{
        emoBar.innerHTML = EMO_ORDER.map(e => `<div class="emo-seg" title="${e}" style="flex:0.15;background:${EMO_COLORS[e]};opacity:0.25"></div>`).join('');
      });
    }
  }

  updateSendBtn(sess);
  renderSidebar();
  saveSessions();
  inputEl.focus();
}

function closeSession(id) {
  const sess = sessions.get(id);
  if (!sess) return;

  if (sess.pinned) {
    if (!confirm('Unpin and close this session?')) return;
  }

  if (sess.sending || (sess.dispatchId && !sess.dispatchDone)) {
    if (!confirm('Running operation — kill and close?')) return;
    if (sess.sending) fetch('/api/kill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId:id})}).catch(()=>{});
    if (sess.dispatchId && !sess.dispatchDone) fetch('/api/kill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({dispatchId:sess.dispatchId})}).catch(()=>{});
  }

  if (sess.polling) clearInterval(sess.polling);
  if (sess.typingTimer) clearInterval(sess.typingTimer);
  fetch('/api/tab/close',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId:id})}).catch(()=>{});
  localStorage.removeItem('emolt-dispatch-msgs-'+id);

  if (sess.el.parentNode) sess.el.remove();
  sessions.delete(id);

  if (activeId === id) {
    activeId = null;
    const remaining = [...sessions.keys()];
    if (remaining.length > 0) switchSession(remaining[remaining.length-1]);
    else createSession('chat');
  } else {
    renderSidebar();
  }
  saveSessions();
}

// ═══════════════════════════════════════════
//  SIDEBAR RENDERING
// ═══════════════════════════════════════════
function renderSidebar() {
  sidebarList.innerHTML = '';
  if (sessions.size === 0) {
    sidebarList.innerHTML = '<div class="sidebar-empty">no sessions</div>';
    return;
  }
  const sorted = [...sessions.entries()].sort((a, b) => (b[1].pinned ? 1 : 0) - (a[1].pinned ? 1 : 0));
  for (const [id, s] of sorted) {
    const d = document.createElement('div');
    d.className = 'sidebar-item' + (id === activeId ? ' active' : '');
    d.dataset.id = id;
    d.onclick = (e) => { if (!e.target.closest('.sidebar-item-close') && !e.target.closest('.sidebar-item-pin') && !e.target.closest('.sidebar-rename-input')) switchSession(id); };
    const modeColors = { chat:'var(--accent)', dispatch:'var(--dispatch)', dev:'var(--dev)' };
    const color = modeColors[s.type] || 'var(--accent)';
    const running = s.sending || (s.dispatchId && !s.dispatchDone);
    const statusParts = [s.type];
    if (s.pinned) statusParts.push('pinned');
    if (running) statusParts.push('running');
    d.innerHTML = `
      <div class="sidebar-item-dot" style="background:${color}${running ? ';animation:breathe 1.5s ease-in-out infinite' : ''}"></div>
      <div class="sidebar-item-info">
        <div class="sidebar-item-label" ondblclick="startRename('${id}')">${esc(s.label)}</div>
        <div class="sidebar-item-type">${statusParts.join(' · ')}</div>
      </div>
      <span class="sidebar-item-pin${s.pinned ? ' pinned' : ''}" onclick="togglePin('${id}')" title="${s.pinned ? 'unpin' : 'pin'}">
        <svg viewBox="0 0 16 16"><path d="M8 10.5v4.5"/><path d="M4 10h8"/><path d="M5.5 10V6.5L7 4h2l1.5 2.5V10"/></svg>
      </span>
      <span class="sidebar-item-close" onclick="closeSession('${id}')">&times;</span>
    `;
    sidebarList.appendChild(d);
  }
}

function toggleSidebar() { $('sidebar').classList.toggle('open'); $('sidebarOverlay').classList.toggle('open'); }
function closeSidebar() { $('sidebar').classList.remove('open'); $('sidebarOverlay').classList.remove('open'); }

function togglePin(id) {
  const sess = sessions.get(id);
  if (!sess) return;
  sess.pinned = !sess.pinned;
  saveSessions();
  renderSidebar();
}

function startRename(id) {
  const sess = sessions.get(id);
  if (!sess) return;
  const item = sidebarList.querySelector(`.sidebar-item[data-id="${id}"]`);
  if (!item) return;
  const labelEl = item.querySelector('.sidebar-item-label');
  if (!labelEl) return;

  const input = document.createElement('input');
  input.className = 'sidebar-rename-input';
  input.value = sess.label;
  input.maxLength = 40;
  labelEl.replaceWith(input);
  input.focus();
  input.select();

  let done = false;
  const finish = () => {
    if (done) return;
    done = true;
    const val = input.value.trim();
    if (val && val !== sess.label) {
      sess.label = val;
      saveSessions();
    }
    renderSidebar();
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); finish(); }
    if (e.key === 'Escape') { done = true; renderSidebar(); }
  });
  input.addEventListener('blur', finish);
}

// ═══════════════════════════════════════════
//  PERSISTENCE
// ═══════════════════════════════════════════
function saveSessions() {
  const data = [...sessions.values()].map(s=>({id:s.id,type:s.type,label:s.label,serverSessionId:s.serverSessionId,pinned:s.pinned,dispatchId:s.dispatchId||null,dispatchDone:!!s.dispatchDone}));
  localStorage.setItem('emolt-sessions', JSON.stringify(data));
  localStorage.setItem('emolt-active', activeId);
}

function restoreSessions() {
  try {
    const data = JSON.parse(localStorage.getItem('emolt-sessions')||'[]');
    const savedActive = localStorage.getItem('emolt-active');
    if (!data.length) { createSession('chat'); return; }
    for (const d of data) {
      const s = createSession(d.type, { id: d.id, silent: true });
      s.label = d.label;
      s.serverSessionId = d.serverSessionId;
      s.pinned = !!d.pinned;
      s.dispatchId = d.dispatchId || null;
      s.dispatchDone = !!d.dispatchDone;
      if (d.type === 'dispatch') restoreDispatchHistory(s);
      else if (d.serverSessionId) restoreHistory(s);
    }
    renderSidebar();
    if (savedActive && sessions.has(savedActive)) switchSession(savedActive);
    else switchSession([...sessions.keys()][0]);
    saveSessions();
  } catch { createSession('chat'); }
}

async function restoreHistory(sess) {
  if (!sess.serverSessionId) return;
  try {
    const res = await fetch('/api/history?session='+encodeURIComponent(sess.serverSessionId));
    const data = await res.json();
    if (data.entries && data.entries.length > 0) {
      sess.el.innerHTML = '';
      for (const e of data.entries) {
        addMsg(sess,'user',e.user);
        addMsg(sess,'emolt',e.emolt,{thinking:e.thinking,emotionalNuance:e.emotionalNuance,durationMs:e.durationMs,timestamp:e.timestamp});
      }
    }
  } catch {}
}

function saveDispatchMessages(sess) {
  const msgs = [];
  for (const el of sess.el.querySelectorAll('.msg.user, .msg.emolt')) {
    const bubble = el.querySelector('.msg-bubble');
    if (!bubble) continue;
    const role = el.classList.contains('user') ? 'user' : 'emolt';
    msgs.push({ role, content: bubble.textContent });
  }
  if (msgs.length) localStorage.setItem('emolt-dispatch-msgs-'+sess.id, JSON.stringify(msgs));
}

function restoreDispatchMessages(sess) {
  try {
    const raw = localStorage.getItem('emolt-dispatch-msgs-'+sess.id);
    if (!raw) return;
    const msgs = JSON.parse(raw);
    for (const m of msgs) addMsg(sess, m.role, m.content);
  } catch {}
}

async function restoreDispatchHistory(sess) {
  restoreDispatchMessages(sess);
  if (!sess.dispatchId) return;
  try {
    const res = await fetch('/api/dispatch/status?id='+encodeURIComponent(sess.dispatchId));
    const data = await res.json();
    if (!data.plan) return;
    const w = sess.el.querySelector('.welcome'); if (w) w.style.display = 'none';
    const el = document.createElement('div'); el.className = 'plan-card'; el.id = 'pc-'+data.plan.id;
    const p = Object.entries(data.plan.params||{}).filter(([,v])=>v!=null&&v!=='').map(([k,v])=>`${esc(k)}: ${esc(String(v))}`).join(' | ')||'defaults';
    const st = data.plan.status;
    const actionHtml = st==='pending'
      ? `<button class="plan-card-btn approve" onclick="approvePlan('${data.plan.id}')">APPROVE</button><button class="plan-card-btn reject" onclick="rejectPlan('${data.plan.id}')">REJECT</button>`
      : st==='cancelled'
        ? '<span style="color:var(--text-ghost);font-family:\'JetBrains Mono\',monospace;font-size:10px;letter-spacing:1px">CANCELLED</span>'
        : '<span style="color:var(--dispatch);font-family:\'JetBrains Mono\',monospace;font-size:10px;letter-spacing:1px">APPROVED &#10003;</span>';
    const pendingCls = st==='pending' ? ' pending' : '';
    el.innerHTML=`<div class="plan-card-inner${pendingCls}">
      <div class="plan-card-header"><span class="plan-card-emoji">&#9823;</span>DISPATCH PLAN</div>
      <div class="plan-card-summary">${esc(data.plan.summary||'')}</div>
      <div class="plan-card-emotional">${esc(data.plan.emotionalTake||'')}</div>
      <div class="plan-card-params">${p}</div>
      <div class="plan-card-risks">${esc(data.plan.risks||'')}</div>
      <div class="plan-card-actions" id="pa-${data.plan.id}">${actionHtml}</div>
    </div>`;
    sess.el.appendChild(el);
    const log = data.recentLog || [];
    for (const entry of log) renderEntry(sess, entry);
    sess.lastSeenLogIdx = log.length;
    if (['complete','failed','killed'].includes(st)) {
      sess.dispatchDone = true;
      if (data.result) renderResult(sess, data.result, st==='killed');
    } else if (st === 'running') {
      startPolling(sess);
    }
  } catch {}
}

// ═══════════════════════════════════════════
//  MESSAGES
// ═══════════════════════════════════════════
function addMsg(sess, role, content, meta={}) {
  const w = sess.el.querySelector('.welcome');
  if (w) w.style.display = 'none';
  sess.msgCount++;

  if (role === 'user' && sess.msgCount <= 2) {
    sess.label = content.slice(0,30) + (content.length>30?'...':'');
    renderSidebar();
    saveSessions();
  }

  const el = document.createElement('div');
  el.className = `msg ${role}`;
  const time = fmtTime(meta.timestamp||new Date().toISOString());

  // Use markdown rendering for dev mode emolt responses
  const isDevEmolt = sess.type === 'dev' && role === 'emolt';
  const bubbleContent = isDevEmolt ? renderMarkdown(content) : esc(content);

  let h = `<div class="msg-bubble">${bubbleContent}</div><div class="msg-meta">`;
  if (role==='emolt' && (meta.thinking||meta.emotionalNuance||meta.context)) {
    const op = showAllThinking ? 'open' : '';
    const label = sess.type === 'dev' ? 'context' : 'internals';
    h += `<div class="internals-toggle" onclick="togInt(this)"><span class="internals-arrow ${op}">&#9654;</span> ${label}${meta.durationMs?`<span class="internals-dur">${(meta.durationMs/1000).toFixed(1)}s</span>`:''}</div>`;
  }
  h += `<span class="msg-time">${time}</span></div>`;
  if (role==='emolt' && (meta.thinking||meta.emotionalNuance||meta.context)) {
    const op = showAllThinking ? 'open' : '';
    const nuanceLabel = sess.type === 'dev' ? 'context' : 'emotional nuance';
    const nuanceContent = meta.context || meta.emotionalNuance;
    h += `<div class="internals-panel ${op}"><div class="internals-inner"><div class="internals-content">
      ${meta.thinking?`<div class="internals-section"><div class="internals-label">thinking</div><div class="internals-text">${esc(meta.thinking)}</div></div>`:''}
      ${nuanceContent?`<div class="internals-section"><div class="internals-label">${nuanceLabel}</div><div class="internals-text">${esc(nuanceContent)}</div></div>`:''}
    </div></div></div>`;
  }
  el.innerHTML = h;

  if (role==='emolt' && meta.dominantEmotion) {
    const c = EMO_COLORS[meta.dominantEmotion]||'var(--border-hover)';
    const b = el.querySelector('.msg-bubble');
    if (b) b.style.borderLeftColor = c;
  }

  sess.el.appendChild(el);
  scrollTo(sess);
}

function scrollTo(sess) { requestAnimationFrame(()=>sess.el.scrollTo({top:sess.el.scrollHeight,behavior:'smooth'})); }
function togInt(el) { const a=el.querySelector('.internals-arrow'),p=el.closest('.msg').querySelector('.internals-panel'); if(p){a.classList.toggle('open');p.classList.toggle('open');} }
function toggleAllThinking() {
  showAllThinking=!showAllThinking;
  $('thinkBtn').classList.toggle('active',showAllThinking);
  for (const s of sessions.values()) {
    s.el.querySelectorAll('.internals-panel').forEach(p=>p.classList.toggle('open',showAllThinking));
    s.el.querySelectorAll('.internals-arrow').forEach(a=>a.classList.toggle('open',showAllThinking));
  }
}

function updateEmoBar(es) {
  if (!es||!es.emotions) return;
  // Don't overwrite dev mode label
  const activeSess = sessions.get(activeId);
  if (activeSess?.type === 'dev') return;
  let total=0; for(const n of EMO_ORDER) total+=(es.emotions[n]||0); if(total<0.01) total=1;
  let segs=''; for(const n of EMO_ORDER){const v=es.emotions[n]||0;segs+=`<div class="emo-seg" style="flex-basis:${(v/total*100).toFixed(1)}%;background:${EMO_COLORS[n]};opacity:${0.3+v*0.7}" title="${n}: ${v.toFixed(2)}"></div>`;}
  let label=''; if(es.dominantLabel) label=`<span class="emo-label emo-label-dominant">${es.dominantLabel}</span>`;
  if(es.compounds&&es.compounds.length) label+=es.compounds.map(c=>`<span class="emo-label" style="color:var(--accent-lt)">${c}</span>`).join('');
  emoBar.innerHTML=`<div class="emo-track">${segs}</div>${label}`;
}

// Typing
function showTyping(sess) {
  const el=document.createElement('div'); el.className='typing active'; el.id='typ-'+sess.id;
  el.innerHTML=`<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><span class="typing-elapsed"></span>`;
  sess.el.appendChild(el); scrollTo(sess);
  sess.typingStart=Date.now();
  const elapsed=el.querySelector('.typing-elapsed');
  sess.typingTimer=setInterval(()=>{elapsed.textContent=((Date.now()-sess.typingStart)/1000|0)+'s';},1000);
}
function hideTyping(sess) {
  if(sess.typingTimer){clearInterval(sess.typingTimer);sess.typingTimer=null;}
  const el=sess.el.querySelector('#typ-'+sess.id); if(el) el.remove();
}

function updateSendBtn(sess) {
  if(sess.sending){sendBtn.classList.add('stop-mode');sendBtn.disabled=false;sendIcon.style.display='none';stopIcon.style.display='';}
  else{sendBtn.classList.remove('stop-mode');sendBtn.disabled=false;sendIcon.style.display='';stopIcon.style.display='none';}
}

// ═══════════════════════════════════════════
//  SEND / KILL
// ═══════════════════════════════════════════
function handleSendClick() {
  const s=sessions.get(activeId); if(!s) return;
  if(s.sending) killChat(s); else send();
}

async function killChat(sess) {
  try{await fetch('/api/kill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId:sess.id})})}catch{}
}

async function killCurrentDispatch() {
  const s=sessions.get(activeId); if(!s||!s.dispatchId) return;
  if(!confirm('Kill this dispatch?')) return;
  killBtn.disabled=true; killBtn.style.opacity='0.4';
  try{await fetch('/api/kill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({dispatchId:s.dispatchId})})}catch{}
  finally{killBtn.disabled=false; killBtn.style.opacity='';}
}

async function send() {
  const s=sessions.get(activeId); if(!s) return;
  const text=inputEl.value.trim(); if(!text||s.sending) return;
  if(s.type==='dispatch') await sendDispatch(s,text);
  else if(s.type==='dev') await sendDev(s,text);
  else await sendChat(s,text);
}

async function sendChat(sess,text) {
  sess.sending=true; updateSendBtn(sess); inputEl.value=''; inputEl.style.height='auto';
  addMsg(sess,'user',text); showTyping(sess);
  try {
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:sess.id})});
    hideTyping(sess);
    const data=await res.json();
    if(data.aborted){const el=document.createElement('div');el.className='msg-aborted';el.textContent='response cancelled';sess.el.appendChild(el);scrollTo(sess);return;}
    if(!res.ok){addMsg(sess,'emolt',`something went wrong. ${data.error||res.statusText}`);return;}
    if(data.sessionId&&!sess.serverSessionId){sess.serverSessionId=data.sessionId;saveSessions();}
    addMsg(sess,'emolt',data.response,{thinking:data.thinking,emotionalNuance:data.emotionalNuance,durationMs:data.durationMs,timestamp:new Date().toISOString(),dominantEmotion:data.emotionState?.dominant||null});
    updateEmoBar(data.emotionState);
  } catch(err) { hideTyping(sess); addMsg(sess,'emolt',`connection lost. ${err.message}`); }
  finally { sess.sending=false; updateSendBtn(sess); renderSidebar(); inputEl.focus(); }
}

async function sendDev(sess,text) {
  sess.sending=true; updateSendBtn(sess); inputEl.value=''; inputEl.style.height='auto';
  addMsg(sess,'user',text); showTyping(sess);
  try {
    const res=await fetch('/api/dev/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:sess.id})});
    hideTyping(sess);
    const data=await res.json();
    if(data.aborted){const el=document.createElement('div');el.className='msg-aborted';el.textContent='cancelled';sess.el.appendChild(el);scrollTo(sess);return;}
    if(!res.ok){addMsg(sess,'emolt',`something went wrong. ${data.error||res.statusText}`);return;}
    if(data.sessionId&&!sess.serverSessionId){sess.serverSessionId=data.sessionId;saveSessions();}
    addMsg(sess,'emolt',data.response,{thinking:data.thinking,context:data.context,durationMs:data.durationMs,timestamp:new Date().toISOString()});
  } catch(err) { hideTyping(sess); addMsg(sess,'emolt',`connection lost. ${err.message}`); }
  finally { sess.sending=false; updateSendBtn(sess); renderSidebar(); inputEl.focus(); }
}

async function sendDispatch(sess,text) {
  sess.sending=true; updateSendBtn(sess); inputEl.value=''; inputEl.style.height='auto';
  addMsg(sess,'user',text); saveDispatchMessages(sess); showTyping(sess);
  try {
    const res=await fetch('/api/dispatch/plan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:sess.id})});
    hideTyping(sess);
    const data=await res.json();
    if(data.aborted){const el=document.createElement('div');el.className='msg-aborted';el.textContent='planning cancelled';sess.el.appendChild(el);scrollTo(sess);return;}
    if(!res.ok){addMsg(sess,'emolt',`dispatch failed. ${data.error||res.statusText}`);saveDispatchMessages(sess);return;}
    if(!data.understood){addMsg(sess,'emolt',data.response||"i don't know how to do that yet.");saveDispatchMessages(sess);return;}
    sess.dispatchId=data.plan.id;
    saveSessions(); saveDispatchMessages(sess);
    renderPlanCard(sess,data.plan);
  } catch(err) { hideTyping(sess); addMsg(sess,'emolt',`dispatch error. ${err.message}`); saveDispatchMessages(sess); }
  finally { sess.sending=false; updateSendBtn(sess); renderSidebar(); inputEl.focus(); }
}

function useSt(el) { inputEl.value=el.textContent; send(); }

// ═══════════════════════════════════════════
//  DISPATCH UI
// ═══════════════════════════════════════════
function renderPlanCard(sess, plan) {
  const w=sess.el.querySelector('.welcome'); if(w) w.style.display='none';
  const el=document.createElement('div'); el.className='plan-card'; el.id='pc-'+plan.id;
  const p=Object.entries(plan.params||{}).filter(([,v])=>v!=null&&v!=='').map(([k,v])=>`${esc(k)}: ${esc(String(v))}`).join(' | ')||'defaults';
  el.innerHTML=`<div class="plan-card-inner pending">
    <div class="plan-card-header"><span class="plan-card-emoji">&#9823;</span>DISPATCH PLAN</div>
    <div class="plan-card-summary">${esc(plan.summary)}</div>
    <div class="plan-card-emotional">${esc(plan.emotionalTake)}</div>
    <div class="plan-card-params">${p}</div>
    <div class="plan-card-risks">${esc(plan.risks)}</div>
    <div class="plan-card-actions" id="pa-${plan.id}">
      <button class="plan-card-btn approve" onclick="approvePlan('${plan.id}')">APPROVE</button>
      <button class="plan-card-btn reject" onclick="rejectPlan('${plan.id}')">REJECT</button>
    </div>
  </div>`;
  sess.el.appendChild(el); scrollTo(sess);
}

function findSessByDispatch(did) { for(const s of sessions.values()) if(s.dispatchId===did) return s; return null; }

async function approvePlan(pid) {
  const s=findSessByDispatch(pid); if(!s) return;
  const a=document.getElementById('pa-'+pid);
  if(a) a.innerHTML='<span style="color:var(--dispatch);font-family:\'JetBrains Mono\',monospace;font-size:10px;letter-spacing:1px">APPROVED &#10003;</span>';
  const inner=s.el.querySelector('#pc-'+pid+' .plan-card-inner'); if(inner) inner.classList.remove('pending');
  try {
    const res=await fetch('/api/dispatch/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({planId:pid})});
    if(!res.ok){const err=await res.json().catch(()=>({error:'unknown'}));addMsg(s,'emolt',`couldn't launch. ${err.error}`);return;}
    s.lastSeenLogIdx=0; s.dispatchDone=false;
    startPolling(s);
    if(activeId===s.id) killBtn.classList.add('active');
    renderSidebar();
  } catch(err) { addMsg(s,'emolt',`approval failed. ${err.message}`); }
}

async function rejectPlan(pid) {
  const s=findSessByDispatch(pid);
  const a=document.getElementById('pa-'+pid);
  if(a) a.innerHTML='<span style="color:var(--text-ghost);font-family:\'JetBrains Mono\',monospace;font-size:10px;letter-spacing:1px">CANCELLED</span>';
  if(s){const inner=s.el.querySelector('#pc-'+pid+' .plan-card-inner');if(inner)inner.classList.remove('pending');}
  try{await fetch('/api/dispatch/cancel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({planId:pid})})}catch{}
  if(s){s.dispatchId=null;s.dispatchDone=true;killBtn.classList.remove('active');renderSidebar();saveSessions();}
}

function startPolling(s) { if(s.polling) clearInterval(s.polling); s.polling=setInterval(()=>pollStatus(s),800); pollStatus(s); }
function stopPolling(s) { if(s.polling){clearInterval(s.polling);s.polling=null;} }

async function pollStatus(s) {
  if(!s.dispatchId) return;
  try {
    const res=await fetch('/api/dispatch/status?id='+encodeURIComponent(s.dispatchId));
    const data=await res.json();
    if(!data.plan){stopPolling(s);return;}
    const log=data.recentLog||[];
    for(let i=s.lastSeenLogIdx;i<log.length;i++) renderEntry(s,log[i]);
    s.lastSeenLogIdx=log.length;
    if(['complete','failed','killed','cancelled'].includes(data.plan.status) && !s.dispatchDone) {
      s.dispatchDone=true;
      if(data.result) renderResult(s,data.result,data.plan.status==='killed');
      stopPolling(s);
      if(activeId===s.id) killBtn.classList.remove('active');
      renderSidebar();
      saveSessions();
      // Refresh emo bar — dispatch feedback may have changed emotion state
      fetch('/api/state/emotions').then(r=>r.json()).then(d=>{if(d.emotionState)updateEmoBar(d.emotionState);}).catch(()=>{});
    }
  } catch{}
}

function renderEntry(s,e) {
  const el=document.createElement('div'); el.className=`dispatch-entry type-${e.type}`;
  el.innerHTML=`<div class="dispatch-entry-inner"><span style="opacity:0.4;font-size:8px;letter-spacing:0.8px;text-transform:uppercase;margin-right:6px">${esc(e.type)}</span>${esc(e.message)}</div><div class="dispatch-entry-ts">${fmtTime(e.timestamp)}</div>`;
  s.el.appendChild(el); scrollTo(s);
}

function renderResult(s,r,killed) {
  const el=document.createElement('div'); el.className='result-card';
  const cls=killed?'killed':(r.success?'success':'failure');
  const lbl=killed?'DISPATCH KILLED':(r.success?'MISSION COMPLETE':'MISSION FAILED');
  let statsHtml='';
  if(r.stats&&Object.keys(r.stats).length) {
    const st=r.stats;
    const statRow=(k,v,cls)=>`<div class="stat-row"><span class="stat-key">${esc(k)}</span><span class="stat-val${cls?' '+cls:''}">${esc(String(v))}</span></div>`;
    const numCls=(v)=>typeof v==='number'?(v>0?'positive':v<0?'negative':''):'';
    let sections='';
    // Chess stats
    if(st.color||st.moveCount!=null||st.result) {
      const chessPairs=[];
      if(st.result) chessPairs.push(['result',st.result]);
      if(st.color) chessPairs.push(['played as',st.color]);
      if(st.moveCount!=null) chessPairs.push(['moves',st.moveCount]);
      if(st.winner) chessPairs.push(['winner',st.winner]);
      if(st.reason) chessPairs.push(['reason',st.reason]);
      if(st.lobbyId) chessPairs.push(['lobby',st.lobbyId.slice(0,12)+'...']);
      const resCls=st.result==='win'?'positive':st.result==='loss'?'negative':'';
      const chessRows=chessPairs.map(([k,v])=>statRow(k,v,k==='result'?resCls:'')).join('');
      sections+=`<div class="stat-section"><div class="stat-section-label">game</div>${chessRows}</div>`;
      if(st.moves&&st.moves.length) {
        const moveTags=st.moves.map(m=>`<span>${esc(m)}</span>`).join('');
        sections+=`<div class="stat-divider"></div><div class="stat-section"><div class="stat-section-label">moves (${st.moves.length})</div><div class="stat-actions">${moveTags}</div></div>`;
      }
    }
    // Reef stats
    const statusKeys=['zone','level','hp','energy','shells','xp','faction','optimalZone'];
    const statusRows=statusKeys.filter(k=>st[k]!=null).map(k=>statRow(k,st[k])).join('');
    if(statusRows) sections+=`<div class="stat-section"><div class="stat-section-label">status</div>${statusRows}</div>`;
    const sessionPairs=[];
    if(st.actionsPerformed!=null) sessionPairs.push(['actions',st.actionsPerformed]);
    if(st.kills!=null) sessionPairs.push(['kills',st.kills]);
    if(st.deaths!=null) sessionPairs.push(['deaths',st.deaths]);
    if(st.xpGained!=null) sessionPairs.push(['xp gained',st.xpGained>0?'+'+st.xpGained:st.xpGained]);
    if(st.shellsGained!=null) sessionPairs.push(['shells gained',st.shellsGained>0?'+'+st.shellsGained:st.shellsGained]);
    if(st.mode) sessionPairs.push(['mode',st.mode]);
    if(sessionPairs.length) {
      const sessionRows=sessionPairs.map(([k,v])=>statRow(k,v,numCls(typeof v==='string'&&v.startsWith('+')?1:typeof v==='string'&&v.startsWith('-')?-1:typeof v==='number'?v:0))).join('');
      sections+=`<div class="stat-divider"></div><div class="stat-section"><div class="stat-section-label">session</div>${sessionRows}</div>`;
    }
    if(st.equipment&&typeof st.equipment==='object') {
      const eq=st.equipment;
      const eqRows=Object.entries(eq).filter(([,v])=>v).map(([k,v])=>statRow(k,v)).join('');
      if(eqRows) sections+=`<div class="stat-divider"></div><div class="stat-section"><div class="stat-section-label">equipment</div>${eqRows}</div>`;
    }
    if(st.lifetime&&typeof st.lifetime==='object') {
      const lt=st.lifetime;
      const ltRows=Object.entries(lt).map(([k,v])=>statRow(k.replace(/([A-Z])/g,' $1').toLowerCase(),v)).join('');
      if(ltRows) sections+=`<div class="stat-divider"></div><div class="stat-section"><div class="stat-section-label">lifetime</div>${ltRows}</div>`;
    }
    if(st.actions&&Array.isArray(st.actions)&&st.actions.length) {
      const tags=st.actions.map(a=>`<span>${esc(a)}</span>`).join('');
      sections+=`<div class="stat-divider"></div><div class="stat-section"><div class="stat-section-label">action log (${st.actions.length})</div><div class="stat-actions">${tags}</div></div>`;
    }
    if(sections) statsHtml=`<div class="result-card-stats">${sections}</div>`;
  }
  el.innerHTML=`<div class="result-card-inner ${cls}"><div class="result-card-header">${lbl}</div><div class="result-card-summary">${esc(r.summary)}</div><div class="result-card-reflection">${esc(r.emotionalReflection)}</div>${statsHtml}</div>`;
  s.el.appendChild(el); scrollTo(s);
}

// ═══════════════════════════════════════════
//  LOG OVERLAY
// ═══════════════════════════════════════════
async function openLog() { $('logOverlay').classList.add('open'); currentLogTab='chat'; updateLogTabs(); await showSessions('chat'); }
function switchLogTab(t) { currentLogTab=t; updateLogTabs(); if(t==='dispatch') showDispatches(); else showSessions(t); }
function updateLogTabs() { const tabs=document.querySelectorAll('.log-tab'); tabs[0].classList.toggle('active',currentLogTab==='chat'); tabs[1].classList.toggle('active',currentLogTab==='dispatch'); tabs[2].classList.toggle('active',currentLogTab==='dev'); const titles={chat:'CONVERSATION LOG',dispatch:'DISPATCH LOG',dev:'DEV LOG'}; $('logTitle').textContent=titles[currentLogTab]||'LOG'; }

async function showSessions(typeFilter) {
  const b=$('logBody'),c=$('logCount'); b.innerHTML='<div class="log-empty" style="opacity:0.4">loading...</div>';
  // Build set of known session IDs by type from client-side state
  const knownTypes = new Map();
  for (const s of sessions.values()) { if(s.serverSessionId) knownTypes.set(s.serverSessionId, s.type); }
  try{const r=await fetch('/api/sessions');const d=await r.json();let ss=d.sessions||[];
    // Filter by type: 'dev' shows only dev sessions, 'chat' shows only chat (non-dev, non-dispatch)
    if(typeFilter==='dev') ss=ss.filter(s=>knownTypes.get(s.id)==='dev');
    else if(typeFilter==='chat') ss=ss.filter(s=>knownTypes.get(s.id)!=='dev');
    const label=typeFilter==='dev'?'dev sessions':'sessions';
    c.textContent=ss.length+' '+label;
    if(!ss.length){b.innerHTML=`<div class="log-empty">no ${label} yet</div>`;return;}
    const tagColor=typeFilter==='dev'?'var(--dev)':'var(--accent)';
    b.innerHTML=ss.map(s=>{const dt=new Date(s.startedAt);const sType=knownTypes.get(s.id);const tag=sType==='dev'?`<span style="color:var(--dev);font-size:9px;letter-spacing:0.5px;margin-left:6px">DEV</span>`:'';return`<div class="log-entry" style="cursor:pointer" onclick="viewSession('${s.id}')"><div class="log-meta"><span class="log-ts">${dt.toLocaleDateString([],{month:'short',day:'numeric'})} ${dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span class="log-dur">${s.entries} exchanges${tag}</span></div><div style="color:var(--text-sec);font-size:12px">${esc(s.preview||'(empty)')}</div></div>`;}).join('');
  }catch(e){b.innerHTML=`<div class="log-empty" style="color:var(--anger)">failed: ${e.message}</div>`;}
}

async function showDispatches() {
  const b=$('logBody'),c=$('logCount'); b.innerHTML='<div class="log-empty" style="opacity:0.4">loading...</div>';
  try{const r=await fetch('/api/dispatches');const d=await r.json();const ds=d.dispatches||[];c.textContent=ds.length+' dispatches';
    if(!ds.length){b.innerHTML='<div class="log-empty">no dispatches yet</div>';return;}
    b.innerHTML=ds.map(d=>{const dt=d.createdAt?new Date(d.createdAt):new Date();const sc=d.status==='complete'?'var(--trust)':d.status==='cancelled'?'var(--text-ghost)':d.status==='killed'?'var(--anticipation)':d.status==='failed'?'var(--dispatch)':'var(--anticipation)';return`<div class="log-entry" style="cursor:pointer" onclick="viewDispatch('${d.id}')"><div class="log-meta"><span class="log-ts">${dt.toLocaleDateString([],{month:'short',day:'numeric'})} ${dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span class="log-dur" style="color:${sc}">${d.status} | ${d.entryCount} entries</span></div><div style="color:var(--text-sec);font-size:12px">${esc(d.preview||d.activity||'(unknown)')}</div></div>`;}).join('');
  }catch(e){b.innerHTML=`<div class="log-empty" style="color:var(--anger)">failed: ${e.message}</div>`;}
}

async function viewDispatch(id) {
  const b=$('logBody'),c=$('logCount'); b.innerHTML='<div class="log-empty" style="opacity:0.4">loading...</div>';
  try{const r=await fetch('/api/dispatch/log?id='+encodeURIComponent(id));const d=await r.json();const es=d.entries||[];c.textContent=es.length+' entries';
    const hdr=`<div class="log-entry" style="cursor:pointer;border-bottom:1px solid var(--border-hover)" onclick="showDispatches()"><span style="color:var(--dispatch);font-family:'JetBrains Mono',monospace;font-size:10px">&#9664; all dispatches</span></div>`;
    if(!es.length){b.innerHTML=hdr+'<div class="log-empty">empty</div>';return;}
    const tc={plan:'var(--text-sec)',approval:'var(--trust)',step:'var(--text-sec)',thought:'var(--text-muted)',action:'var(--dispatch)',result:'var(--joy)',error:'var(--dispatch)',complete:'var(--trust)'};
    b.innerHTML=hdr+es.map(e=>`<div class="log-entry"><div class="log-meta"><span class="log-ts">${e.timestamp}</span><span class="log-dur" style="color:${tc[e.type]||'var(--text-muted)'}">${e.type}</span></div><div style="color:var(--text-sec);font-size:12px;white-space:pre-wrap">${esc(e.message)}</div></div>`).join('');
    b.scrollTop=0;
  }catch(e){b.innerHTML=`<div class="log-empty" style="color:var(--anger)">failed: ${e.message}</div>`;}
}

async function viewSession(id) {
  const b=$('logBody'),c=$('logCount'); b.innerHTML='<div class="log-empty" style="opacity:0.4">loading...</div>';
  try{const r=await fetch('/api/history?session='+encodeURIComponent(id));const d=await r.json();const es=d.entries||[];c.textContent=es.length+' exchanges';
    const hdr=`<div class="log-entry" style="cursor:pointer;border-bottom:1px solid var(--border-hover)" onclick="showSessions(currentLogTab)"><span style="color:${currentLogTab==='dev'?'var(--dev)':'var(--accent)'};font-family:'JetBrains Mono',monospace;font-size:10px">&#9664; all sessions</span></div>`;
    if(!es.length){b.innerHTML=hdr+'<div class="log-empty">empty session</div>';return;}
    b.innerHTML=hdr+es.map(e=>`<div class="log-entry"><div class="log-meta"><span class="log-ts">${e.timestamp}</span><span class="log-dur">${e.durationMs?(e.durationMs/1000).toFixed(1)+'s':''}</span></div><div class="log-user-msg">${esc(e.user)}</div><div class="log-emolt-msg">${esc(e.emolt)}</div>${e.thinking?`<div class="log-internal">${esc(e.thinking)}</div>`:''}${e.emotionalNuance?`<div class="log-internal">${esc(e.emotionalNuance)}</div>`:''}</div>`).join('');
    b.scrollTop=0;
  }catch(e){b.innerHTML=`<div class="log-empty" style="color:var(--anger)">failed: ${e.message}</div>`;}
}

function closeLog(e) { if(e&&e.target!==$('logOverlay')) return; $('logOverlay').classList.remove('open'); }

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
inputEl.addEventListener('input',()=>{inputEl.style.height='auto';inputEl.style.height=Math.min(inputEl.scrollHeight,140)+'px';});
inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendClick();}});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){$('logOverlay').classList.remove('open');closeSidebar();}});

restoreSessions();
inputEl.focus();

// Fetch current emotion state on load
fetch('/api/state/emotions').then(r=>r.json()).then(d=>{if(d.emotionState)updateEmoBar(d.emotionState);}).catch(()=>{});
</script>
</body>
</html>
